
{{- $chartName := include "mapproxy.name" . -}}
{{- $serviceName := include "service.fullname" . -}}
{{- $releaseName := .Release.Name -}}

upstream mapproxy-wms {
    server {{ $serviceName }}-wms:{{ .Values.mapproxy.uwsgi.httpSocket }};
}

upstream mapproxy-wmts {
    server {{ $serviceName }}-wmts:{{ .Values.mapproxy.uwsgi.httpSocket }};
}

map $msec $nanosec {
    "~*(\d{10})\.(\d{3})" "$1$2000000";
}

{{- if .Values.nginx.cache.enabled }}
proxy_cache_path {{ .Values.nginx.cache.cachePath }} levels={{ .Values.nginx.cache.levels }}
keys_zone={{ .Values.nginx.cache.keysZone }}:{{ .Values.nginx.cache.keysZoneSize }}
max_size={{ .Values.nginx.cache.maxSize }} inactive={{ .Values.nginx.cache.inactive }} use_temp_path={{ .Values.nginx.cache.useTempPath }};
{{- end }}

server {
    listen      {{ .Values.nginx.targetPort }};
    # the domain name it will serve for
    server_name mapproxy;
    # max upload size, adjust to taste
    keepalive_timeout  500;
    proxy_connect_timeout       600;
    proxy_send_timeout          600;
    send_timeout                600;
    client_max_body_size        5000;
    client_header_timeout       600;
    client_body_timeout         600;
    client_header_buffer_size   12288; # 12K
    large_client_header_buffers 4 12288; # 12K
    fastcgi_read_timeout        300;
    location /liveness {
        access_log    off;
        log_not_found off;
        return 200 "I'm alive\n";
    }

    location {{ .Values.mapproxy.route.path }}/service/wmts {
        include nginx.mapproxy.conf;
        include nginx.mapproxy.wmts.conf;
        proxy_pass http://mapproxy-wmts;
    }

    location {{ .Values.mapproxy.route.path }}/service/wms {
        include nginx.mapproxy.conf;
        proxy_pass http://mapproxy-wms;
    }

    location {{ .Values.mapproxy.route.path }}/service {
        if ($arg_service = 'wmts') {
            rewrite ^ {{ .Values.mapproxy.route.path }}/service/wmts last;
        }
        if ($arg_service = 'wms') {
            rewrite ^ {{ .Values.mapproxy.route.path }}/service/wms last;
        }
        include nginx.mapproxy.conf;
        proxy_pass http://mapproxy-wmts;
    }

    location {{ .Values.mapproxy.route.path }}/wmts {
        include nginx.mapproxy.conf;
        include nginx.mapproxy.wmts.conf;
        proxy_pass http://mapproxy-wmts;
    }

    location {{ .Values.mapproxy.route.path }} {
        include nginx.mapproxy.conf;
        proxy_pass http://mapproxy-wmts;
    }
}
